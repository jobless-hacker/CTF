# ZeroTrace CTF - DATA_MODELS (MVP)

## Scope

This document defines the database data models for the ZeroTrace CTF MVP only.

Covered MVP scope:

- Authentication
- User roles (`admin`, `player`)
- Tracks (`Linux`, `Networking`, `Crypto`)
- Challenges
- Flag validation
- XP system
- Leaderboard
- Attempt tracking
- Admin challenge management

Excluded from this document and MVP:

- Docker labs
- Cloud lab instances
- SOC log ingestion
- Dynamic lab orchestration

## 1. Database Design Principles

### Naming Conventions

- Table names use plural `snake_case` (for example: `challenge_attempts`).
- Column names use singular `snake_case`.
- Foreign key columns use `<referenced_entity>_id` (for example: `user_id`, `challenge_id`).
- Boolean columns use `is_*` naming (for example: `is_active`, `is_published`).
- Timestamp columns use `*_at` naming (for example: `created_at`, `attempted_at`).
- Enum-like values are stored as constrained `varchar` values in MVP (for example: `difficulty`, `action_type`).

### UUID Usage

- UUIDs are used for primary keys on all entity and event tables.
- `user_xp` uses `user_id` (UUID) as both primary key and foreign key to enforce a 1:1 relationship.
- UUIDs are used to avoid predictable sequential identifiers for user, challenge, and audit data.

### Soft Delete Strategy

- No generic soft delete pattern is used in MVP.
- Deactivation/state flags are used instead:
  - `users.is_active`
  - `tracks.is_active`
  - `challenges.is_published`
  - `challenge_flags.is_active`
- Historical/event tables are append-only and must not be deleted as part of normal operations.
- Physical deletes should be restricted to test/setup data and must not break historical records.

### Timestamp Strategy

- All timestamps are stored in UTC.
- Mutable tables use `created_at` and `updated_at`.
- Event/history tables use immutable event timestamps (`attempted_at`, `awarded_at`, `created_at`) and should not be updated after insert.
- Timestamps are generated by the backend, not the client.

### Indexing Philosophy

- Add indexes for primary read paths first: auth lookup, challenge listing, submissions, leaderboard, admin audit review.
- Add unique constraints/indexes for business invariants: unique users, unique solves, unique XP awards.
- Index all foreign key columns used in joins.
- Use composite indexes for common filtered/sorted queries (for example: leaderboard ordering, recent attempts).
- Avoid indexing long sensitive text fields (`submitted_flag`); use hashes for correlation and abuse detection.
- Prefer conditional unique indexes for rules such as "one successful solve per user per challenge".

### Relational Integrity and Delete Behavior

- Foreign keys should default to non-cascading delete behavior.
- Historical integrity takes priority over convenience deletion.
- If an actor reference must be retained but the actor is no longer active, the user should be deactivated rather than deleted.
- History tables (`challenge_attempts`, `xp_history`, `admin_logs`, optional `leaderboard_snapshot`) must remain queryable even if source entities are unpublished or inactive.

## 2. Tables Overview List

| Table Name | Purpose | MVP Status | Notes |
|---|---|---|---|
| `users` | Authentication identity and account state | Required | Stores credentials and active status |
| `roles` | Role catalog (`admin`, `player`) | Required | Seeded system roles |
| `user_roles` | User-to-role assignments | Required | Supports RBAC and role changes |
| `tracks` | Challenge domain grouping | Required | Seeded to Linux, Networking, Crypto |
| `challenges` | Challenge definitions and publication state | Required | Admin-managed content |
| `challenge_flags` | Hashed valid flags per challenge | Required | Supports multiple valid flags |
| `challenge_attempts` | Submission attempts and correctness outcome | Required | Core abuse monitoring surface |
| `user_xp` | Current XP totals and leaderboard tie-break data | Required | 1 row per user |
| `xp_history` | Immutable XP event ledger | Required | Prevents dynamic recalculation dependency |
| `leaderboard_snapshot` | Cached/historical leaderboard rows | Optional | Not required for initial MVP launch |
| `admin_logs` | Admin action audit logs | Required | Challenge edits and role changes |

## 3. Table Definitions

### `users`

**Description**

Stores player/admin account identity, authentication data, and account status for MVP login and authorization.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the user account. |
| `email` | varchar | Required. Unique email address stored in normalized form (lowercase). |
| `username` | varchar | Required. Unique display/login handle for leaderboard and UI display. |
| `password_hash` | varchar | Required. Password hash only. Never store plaintext passwords. |
| `is_active` | boolean | Required. Account activation state. Deactivated accounts cannot authenticate. |
| `last_login_at` | timestamp | Nullable. Updated on successful login for operational visibility. |
| `created_at` | timestamp | Required. Account creation timestamp. |
| `updated_at` | timestamp | Required. Last account metadata update timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- None

**Indexes**

- Unique index on `email`
- Unique index on `username`
- Index on `is_active`
- Index on `created_at`

**Constraints**

- `email` must be non-empty and normalized before storage.
- `username` must be non-empty.
- `password_hash` must be non-empty.
- `is_active` defaults to `true`.
- No physical delete in normal operations; deactivate instead to preserve history.

**Relationships**

- One-to-many with `user_roles`
- One-to-many with `challenge_attempts`
- One-to-one with `user_xp`
- One-to-many with `xp_history`
- One-to-many with `admin_logs` (as actor or affected user)
- One-to-many with `challenges` (as creator/updater)
- One-to-many with `challenge_flags` (as creator)

### `roles`

**Description**

Role catalog used for RBAC. MVP supports only `admin` and `player`.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the role record. |
| `name` | varchar | Required. Unique role name. MVP allowed values: `admin`, `player`. |
| `description` | text | Optional. Internal description of role purpose. |
| `is_system` | boolean | Required. Marks seeded roles that should not be deleted or renamed in MVP. |
| `created_at` | timestamp | Required. Role creation timestamp. |
| `updated_at` | timestamp | Required. Last role metadata update timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- None

**Indexes**

- Unique index on `name`
- Index on `is_system`

**Constraints**

- `name` must be unique.
- MVP role set is restricted to `admin` and `player`.
- Seeded system roles must be protected from destructive edits.

**Relationships**

- One-to-many with `user_roles`
- One-to-many with `admin_logs` (as affected role in role-change events)

### `user_roles`

**Description**

Current role assignments for users. Supports RBAC while keeping role-change history in `admin_logs`.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the role assignment row. |
| `user_id` | uuid | Required. References `users.id`. |
| `role_id` | uuid | Required. References `roles.id`. |
| `assigned_by_user_id` | uuid | Nullable. References `users.id` for admin/system actor that assigned the role. |
| `created_at` | timestamp | Required. Assignment creation timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- `user_id` -> `users.id` (non-cascading delete behavior)
- `role_id` -> `roles.id` (non-cascading delete behavior)
- `assigned_by_user_id` -> `users.id` (non-cascading delete behavior; nullable for system-seeded assignments)

**Indexes**

- Unique index on (`user_id`, `role_id`)
- Index on `user_id`
- Index on `role_id`
- Index on `created_at`

**Constraints**

- One user cannot have the same role assigned more than once.
- `assigned_by_user_id` may be null only for system bootstrap/default assignment flows.
- Default MVP registration flow should assign `player`.

**Relationships**

- Many-to-one with `users`
- Many-to-one with `roles`
- Many-to-one with `users` (assignment actor via `assigned_by_user_id`)

### `tracks`

**Description**

Challenge track definitions. MVP is limited to three tracks: Linux, Networking, Crypto.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the track. |
| `slug` | varchar | Required. Unique stable identifier. MVP values: `linux`, `networking`, `crypto`. |
| `name` | varchar | Required. Display name. MVP values: `Linux`, `Networking`, `Crypto`. |
| `description` | text | Optional. Internal/admin description of track scope. |
| `order_index` | integer | Required. Display ordering for dashboard and challenge lists. |
| `is_active` | boolean | Required. Track availability state without deleting history. |
| `created_at` | timestamp | Required. Track creation timestamp. |
| `updated_at` | timestamp | Required. Last track metadata update timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- None

**Indexes**

- Unique index on `slug`
- Unique index on `name`
- Unique index on `order_index`
- Index on `is_active`

**Constraints**

- MVP seed set is limited to three tracks.
- `order_index` must be non-negative.
- `is_active` defaults to `true`.

**Relationships**

- One-to-many with `challenges`

### `challenges`

**Description**

Challenge definitions managed by admins. Stores challenge metadata, publication state, difficulty, ordering, and XP reward.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the challenge. |
| `track_id` | uuid | Required. References `tracks.id`. Each challenge belongs to one track. |
| `slug` | varchar | Required. Unique challenge identifier used in URLs and flag naming conventions. |
| `title` | varchar | Required. Challenge title. |
| `description` | text | Required. Challenge prompt/content shown to users. |
| `difficulty` | varchar | Required. Allowed values: `easy`, `medium`, `hard`. |
| `xp_reward` | integer | Required. XP awarded for first valid solve. |
| `order_index` | integer | Required. Ordering within the track. |
| `is_published` | boolean | Required. Controls user visibility in MVP. |
| `created_by_user_id` | uuid | Nullable. References `users.id` (admin creator). |
| `updated_by_user_id` | uuid | Nullable. References `users.id` (admin last editor). |
| `published_at` | timestamp | Nullable. Timestamp when first published or last re-published (platform policy dependent). |
| `created_at` | timestamp | Required. Challenge creation timestamp. |
| `updated_at` | timestamp | Required. Last challenge update timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- `track_id` -> `tracks.id` (non-cascading delete behavior)
- `created_by_user_id` -> `users.id` (non-cascading delete behavior; nullable for seeded imports)
- `updated_by_user_id` -> `users.id` (non-cascading delete behavior; nullable for seeded imports)

**Indexes**

- Unique index on `slug`
- Composite index on (`track_id`, `is_published`, `order_index`)
- Composite index on (`track_id`, `difficulty`)
- Index on `is_published`
- Index on `xp_reward`

**Constraints**

- `difficulty` must be one of `easy`, `medium`, `hard`.
- `xp_reward` must be positive.
- `order_index` must be non-negative.
- Recommended unique constraint on (`track_id`, `order_index`) to prevent ambiguous track ordering.
- A challenge should not be published unless at least one active `challenge_flags` row exists (application-enforced transactional rule).

**Relationships**

- Many-to-one with `tracks`
- One-to-many with `challenge_flags`
- One-to-many with `challenge_attempts`
- One-to-many with `xp_history`
- One-to-many with `admin_logs`

### `challenge_flags`

**Description**

Stores hashed valid flags for challenges. Supports multiple valid flags per challenge for rotations, aliases, or compatibility without storing plaintext flags.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the flag record. |
| `challenge_id` | uuid | Required. References `challenges.id`. |
| `flag_hash` | varchar | Required. Cryptographic digest of the normalized flag. Plaintext flag must not be stored. |
| `hash_algorithm` | varchar | Required. Identifier for the hashing strategy used to generate `flag_hash`. |
| `hash_key_version` | varchar | Required. Key/version identifier to support hash secret rotation without rewriting history assumptions. |
| `normalization_version` | varchar | Required. Indicates flag normalization rules used before hashing. |
| `is_active` | boolean | Required. Enables multiple stored flags while controlling which ones are valid. |
| `created_by_user_id` | uuid | Nullable. References `users.id` (admin creator/import actor). |
| `created_at` | timestamp | Required. Flag record creation timestamp. |
| `updated_at` | timestamp | Required. Last flag metadata state update timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- `challenge_id` -> `challenges.id` (non-cascading delete behavior)
- `created_by_user_id` -> `users.id` (non-cascading delete behavior; nullable for seeded imports)

**Indexes**

- Composite index on (`challenge_id`, `is_active`)
- Composite index on (`challenge_id`, `flag_hash`)
- Unique index on (`challenge_id`, `flag_hash`)
- Index on `created_at`

**Constraints**

- Plaintext flags are prohibited in this table.
- Multiple valid flags are supported through multiple rows per challenge.
- `flag_hash` must be unique per challenge.
- At least one active flag should exist before a challenge is published (application-enforced rule).

**Relationships**

- Many-to-one with `challenges`
- Many-to-one with `users` (creator/import actor)

### `challenge_attempts`

**Description**

Immutable log of player submission attempts for challenges, including correctness outcome and security-relevant metadata for abuse detection and brute-force control.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the attempt record. |
| `user_id` | uuid | Required. References `users.id`. |
| `challenge_id` | uuid | Required. References `challenges.id`. |
| `submitted_flag` | text | Required. Sensitive submitted flag value for audit/dispute handling; treat as protected data with strict access controls and retention policy. |
| `submitted_flag_hash` | varchar | Required. Hash of normalized submitted flag for duplicate-guess detection and abuse analytics. |
| `is_correct` | boolean | Required. `true` only when the submission matches an active valid flag for the challenge. |
| `attempt_status` | varchar | Required. Allowed values should distinguish processed attempts from blocked attempts (for example: `processed`, `rejected_rate_limited`, `rejected_already_solved`). |
| `source_ip_hash` | varchar | Nullable. Hashed client IP for brute-force detection and rate-limit analytics. |
| `user_agent_hash` | varchar | Nullable. Hashed client agent fingerprint for abuse correlation. |
| `attempted_at` | timestamp | Required. Submission timestamp (the required attempt timestamp field for MVP). |

**Primary Key**

- `id`

**Foreign Keys**

- `user_id` -> `users.id` (non-cascading delete behavior)
- `challenge_id` -> `challenges.id` (non-cascading delete behavior)

**Indexes**

- Composite index on (`user_id`, `challenge_id`, `attempted_at`)
- Composite index on (`user_id`, `attempted_at`)
- Composite index on (`challenge_id`, `attempted_at`)
- Composite index on (`source_ip_hash`, `attempted_at`)
- Composite index on (`challenge_id`, `submitted_flag_hash`, `attempted_at`)
- Conditional unique index on (`user_id`, `challenge_id`) for rows where `is_correct = true`

**Constraints**

- Append-only table. Attempt rows must not be updated after insert except under controlled incident remediation.
- `attempt_status` must be limited to an explicit allowlist.
- `is_correct = true` is only valid for processed attempts.
- Only one successful solve attempt row is allowed per user per challenge (enforced by conditional unique index).
- Brute-force resistance is supported by indexed time-series attempt data (`user_id`, `challenge_id`, `source_ip_hash`) and blocked attempt logging.
- Sensitive `submitted_flag` values must not be used in indexes, logs, or admin listings.

**Relationships**

- Many-to-one with `users`
- Many-to-one with `challenges`
- One-to-many with `xp_history` (typically zero or one XP event references a successful attempt)

### `user_xp`

**Description**

Current XP totals and leaderboard tie-break state for each user. This table is the read model for leaderboard and dashboard summary views.

**Fields**

| field_name | type | description |
|---|---|---|
| `user_id` | uuid | Primary key and foreign key. References `users.id`. One row per user. |
| `total_xp` | integer | Required. Current accumulated XP. Not recalculated dynamically for normal reads. |
| `solved_challenges_count` | integer | Required. Count of unique challenges solved by the user. |
| `tie_breaker_completed_at` | timestamp | Nullable. Timestamp when the user reached the current `total_xp`; earlier timestamp ranks higher on XP ties. |
| `created_at` | timestamp | Required. Row creation timestamp. |
| `updated_at` | timestamp | Required. Last XP aggregate update timestamp. |

**Primary Key**

- `user_id`

**Foreign Keys**

- `user_id` -> `users.id` (non-cascading delete behavior)

**Indexes**

- Composite index for leaderboard sorting on (`total_xp`, `tie_breaker_completed_at`, `user_id`)
- Index on `solved_challenges_count`
- Index on `updated_at`

**Constraints**

- `total_xp` must be zero or greater.
- `solved_challenges_count` must be zero or greater.
- `tie_breaker_completed_at` should be null until the first XP-awarding event.
- Updates to `user_xp` must occur transactionally with `xp_history` insertions to prevent leaderboard inconsistency.

**Relationships**

- One-to-one with `users`
- One-to-many logical relationship with `xp_history` (aggregate derived from immutable XP events)

### `xp_history`

**Description**

Immutable XP event ledger. Stores each XP change event and resulting balance to avoid dynamic XP recalculation for operational reads.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the XP event row. |
| `user_id` | uuid | Required. References `users.id`. |
| `event_type` | varchar | Required. XP event category (for example: `challenge_solve`, `admin_adjustment`, `system_correction`). |
| `xp_delta` | integer | Required. XP change amount. Positive for challenge solves; may be negative only for controlled corrections. |
| `balance_after` | integer | Required. User XP total after applying this event. |
| `challenge_id` | uuid | Nullable. References `challenges.id` when the event is challenge-related. |
| `challenge_attempt_id` | uuid | Nullable. References `challenge_attempts.id` that triggered the XP event. |
| `created_by_user_id` | uuid | Nullable. References `users.id` for manual/admin adjustments. |
| `reason` | text | Nullable. Human-readable reason for adjustments/corrections. |
| `awarded_at` | timestamp | Required. XP event timestamp used for audit and replay verification. |

**Primary Key**

- `id`

**Foreign Keys**

- `user_id` -> `users.id` (non-cascading delete behavior)
- `challenge_id` -> `challenges.id` (non-cascading delete behavior; nullable for non-challenge events)
- `challenge_attempt_id` -> `challenge_attempts.id` (non-cascading delete behavior; nullable for non-challenge events)
- `created_by_user_id` -> `users.id` (non-cascading delete behavior; nullable for system-generated events)

**Indexes**

- Composite index on (`user_id`, `awarded_at`)
- Composite index on (`user_id`, `event_type`, `awarded_at`)
- Index on `challenge_id`
- Unique index on `challenge_attempt_id` (where not null)
- Conditional unique index on (`user_id`, `challenge_id`, `event_type`) for `event_type = challenge_solve`

**Constraints**

- Append-only table. XP history rows must not be updated or deleted in normal operations.
- `balance_after` must be zero or greater.
- `challenge_solve` events must reference both `challenge_id` and `challenge_attempt_id`.
- `challenge_solve` events must award XP only once per user per challenge (duplicate XP prevention).
- `balance_after` should match transactional updates applied to `user_xp`.

**Relationships**

- Many-to-one with `users` (recipient)
- Many-to-one with `challenges` (challenge-linked events)
- Many-to-one with `challenge_attempts` (source attempt)
- Many-to-one with `users` (actor for manual adjustments)

### `leaderboard_snapshot` (Optional)

**Description**

Optional denormalized snapshot rows for leaderboard caching, historical comparisons, and dispute analysis. MVP can operate without this table by reading directly from `user_xp`.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the snapshot row. |
| `snapshot_at` | timestamp | Required. Timestamp identifying the snapshot batch. |
| `snapshot_type` | varchar | Required. Snapshot source/type (for example: `scheduled`, `manual`). |
| `user_id` | uuid | Required. References `users.id`. |
| `rank_position` | integer | Required. Rank of the user within the snapshot. |
| `total_xp` | integer | Required. Copied XP total at snapshot time. |
| `tie_breaker_completed_at` | timestamp | Nullable. Copied leaderboard tie-break timestamp at snapshot time. |
| `solved_challenges_count` | integer | Required. Copied solved count at snapshot time. |
| `created_at` | timestamp | Required. Row insert timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- `user_id` -> `users.id` (non-cascading delete behavior)

**Indexes**

- Composite index on (`snapshot_at`, `rank_position`)
- Composite index on (`user_id`, `snapshot_at`)
- Unique index on (`snapshot_at`, `user_id`)
- Unique index on (`snapshot_at`, `rank_position`)

**Constraints**

- `rank_position` must be greater than zero.
- `total_xp` must be zero or greater.
- `solved_challenges_count` must be zero or greater.
- Snapshot rows are immutable after insert.

**Relationships**

- Many-to-one with `users`

### `admin_logs`

**Description**

Append-only audit log for privileged administrative actions. MVP must capture challenge creation/edits/publication changes and user role assignment/removal events.

**Fields**

| field_name | type | description |
|---|---|---|
| `id` | uuid | Primary key. UUID for the admin log row. |
| `actor_user_id` | uuid | Nullable. References `users.id` for the admin/system actor performing the action. |
| `action_type` | varchar | Required. Action identifier (for example: `challenge_create`, `challenge_update`, `challenge_publish`, `challenge_unpublish`, `user_role_assign`, `user_role_revoke`). |
| `challenge_id` | uuid | Nullable. References `challenges.id` when the action targets a challenge. |
| `affected_user_id` | uuid | Nullable. References `users.id` when the action targets a user (for example role changes). |
| `affected_role_id` | uuid | Nullable. References `roles.id` for role-change actions. |
| `is_success` | boolean | Required. Indicates whether the admin action completed successfully. |
| `change_summary` | text | Required. Human-readable summary of the action outcome. |
| `before_state` | text | Nullable. Redacted serialized pre-change values for auditable fields. |
| `after_state` | text | Nullable. Redacted serialized post-change values for auditable fields. |
| `source_ip_hash` | varchar | Nullable. Hashed source IP for security review. |
| `request_id` | varchar | Nullable. Request correlation identifier for tracing. |
| `created_at` | timestamp | Required. Audit log timestamp. |

**Primary Key**

- `id`

**Foreign Keys**

- `actor_user_id` -> `users.id` (non-cascading delete behavior; nullable for system actions)
- `challenge_id` -> `challenges.id` (non-cascading delete behavior; nullable when action is user/role related)
- `affected_user_id` -> `users.id` (non-cascading delete behavior; nullable when action is challenge related)
- `affected_role_id` -> `roles.id` (non-cascading delete behavior; nullable except role-change actions)

**Indexes**

- Composite index on (`actor_user_id`, `created_at`)
- Composite index on (`action_type`, `created_at`)
- Composite index on (`challenge_id`, `created_at`)
- Composite index on (`affected_user_id`, `created_at`)
- Composite index on (`affected_role_id`, `created_at`)
- Index on `request_id`

**Constraints**

- Append-only table. Admin logs must not be updated or deleted in normal operations.
- `action_type` must be limited to an explicit allowlist.
- Target references must align with `action_type` (challenge actions require `challenge_id`; role-change actions require `affected_user_id` and `affected_role_id`).
- Sensitive values (plaintext flags, password hashes, tokens) are prohibited in `change_summary`, `before_state`, and `after_state`.

**Relationships**

- Many-to-one with `users` (actor)
- Many-to-one with `challenges` (challenge target)
- Many-to-one with `users` (affected user)
- Many-to-one with `roles` (affected role)

## 4. Cross-Table Integrity Rules (MVP-Critical)

### Duplicate XP Prevention

- `challenge_attempts` enforces at most one successful attempt (`is_correct = true`) per user/challenge.
- `xp_history` enforces one `challenge_solve` XP event per user/challenge.
- `xp_history.challenge_attempt_id` is unique (when present) to prevent double-awarding from the same attempt.
- `user_xp` updates must be applied in the same transaction as the `xp_history` insert.

### Flag Security and Enumeration Resistance

- Valid flags are stored only in `challenge_flags` as hashes (`flag_hash`), never plaintext.
- Multiple valid flags per challenge are supported without exposing the original values.
- `challenge_attempts` stores `submitted_flag_hash` for repeated-guess correlation; raw `submitted_flag` is sensitive and access-restricted.
- Attempt rows include indexed timing and source hashes to support rate limiting and brute-force detection.

### Leaderboard Consistency

- Leaderboard reads should use `user_xp` as the authoritative aggregate.
- Sort order for MVP leaderboard:
  - `total_xp` descending
  - `tie_breaker_completed_at` ascending
  - `user_id` ascending (final deterministic tie-break)
- `tie_breaker_completed_at` must reflect when the user reached the current XP total.

### History Preservation

- Do not cascade delete rows from `challenges`, `users`, or `roles` into history tables.
- Use deactivation/unpublish state changes instead of destructive deletes.
- Historical records remain queryable for audit, dispute resolution, and abuse investigation.
